name: Quick Build

on:
  workflow_dispatch:
    inputs:
      skip_tests:
        description: 'Skip tests to speed up build'
        required: false
        default: 'true'
        type: boolean

jobs:
  quick-build:
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      with:
        submodules: false  # Skip submodules to avoid private spam-filter dependency

    - name: Set up JDK 21
      uses: actions/setup-java@v4
      with:
        java-version: '21'
        distribution: 'temurin'

    - name: Cache Maven dependencies
      uses: actions/cache@v4
      with:
        path: ~/.m2
        key: ${{ runner.os }}-m2-quick-${{ hashFiles('**/pom.xml') }}
        restore-keys: ${{ runner.os }}-m2

    - name: Install Protocol Buffer Compiler
      run: |
        sudo apt-get update
        sudo apt-get install -y protobuf-compiler

    - name: Quick Build
      run: |
        if [ "${{ github.event.inputs.skip_tests }}" == "true" ]; then
          echo "Skipping tests for quick build..."
          mvn clean package -DskipTests -Pexclude-spam-filter -q
        else
          echo "Running with tests..."
          mvn clean package -Pexclude-spam-filter -q
        fi
      env:
        MAVEN_OPTS: "-Xmx2048m"

    - name: Prepare artifacts
      run: |
        mkdir -p artifacts
        
        # Find and copy JAR files
        find . -name "*.jar" -not -path "*/target/classes/*" -not -path "*/original-*" | while read jar; do
          basename=$(basename "$jar")
          dirname=$(dirname "$jar")
          module=$(echo "$dirname" | sed 's|.*/||' | sed 's|/target||')
          cp "$jar" "artifacts/${module}-${basename}"
        done
        
        # Copy config
        cp service/config/sample.yml artifacts/config-sample.yml
        
        # Create quick start guide
        cat > artifacts/QUICK-START.md << 'EOF'
        # Quick Start Guide
        
        ## CarlJoy é™æ€éªŒè¯ç ç‰ˆæœ¬
        
        ### ä¸»è¦å˜æ›´ï¼š
        - æ‰‹æœºå·ä½œä¸ºç”¨æˆ·å
        - éªŒè¯ç ä½œä¸ºé™æ€å¯†ç ï¼ˆæ˜Žæ–‡å­˜å‚¨ï¼‰
        - é¦–æ¬¡è¾“å…¥éªŒè¯ç ä¼šè‡ªåŠ¨åˆ›å»ºè´¦æˆ·
        - åŽç»­å¿…é¡»ä½¿ç”¨ç›¸åŒéªŒè¯ç ç™»å½•
        
        ### å¿«é€Ÿå¯åŠ¨ï¼š
        1. ä¿®æ”¹ `config-sample.yml` ä¸º `config.yml`
        2. é…ç½®æ•°æ®åº“è¿žæŽ¥
        3. è¿è¡Œï¼š`java -jar service-signal-server.jar server config.yml`
        
        ### æ•°æ®åº“è¡¨ï¼š
        æ–°å¢žè¡¨ï¼š`staticVerificationCodes`
        - phone_number (ä¸»é”®)
        - verification_code (æ˜Žæ–‡å¯†ç )
        - created_at, updated_at
        EOF

    - name: Upload Quick Build
      uses: actions/upload-artifact@v4
      with:
        name: signal-server-quick-${{ github.run_number }}
        path: artifacts/
        retention-days: 7

    - name: Create download info
      run: |
        echo "âœ… æž„å»ºå®Œæˆï¼" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "ðŸ“¦ **ä¸‹è½½åœ°å€ï¼š**" >> $GITHUB_STEP_SUMMARY
        echo "- ç‚¹å‡»å³ä¸Šè§’ Actions æ ‡ç­¾é¡µ" >> $GITHUB_STEP_SUMMARY
        echo "- æ‰¾åˆ°æœ¬æ¬¡æž„å»º (Build #${{ github.run_number }})" >> $GITHUB_STEP_SUMMARY
        echo "- ä¸‹è½½ 'signal-server-quick-${{ github.run_number }}' åŽ‹ç¼©åŒ…" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "ðŸš€ **åŒ…å«æ–‡ä»¶ï¼š**" >> $GITHUB_STEP_SUMMARY
        echo "- service-signal-server.jar (ä¸»æœåŠ¡)" >> $GITHUB_STEP_SUMMARY
        echo "- websocket-resources-websocket-resources.jar (WebSocketèµ„æº)" >> $GITHUB_STEP_SUMMARY
        echo "- config-sample.yml (é…ç½®æ ·ä¾‹)" >> $GITHUB_STEP_SUMMARY
        echo "- QUICK-START.md (å¿«é€Ÿå¼€å§‹æŒ‡å—)" >> $GITHUB_STEP_SUMMARY 