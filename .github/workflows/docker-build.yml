name: Docker Build

on:
  workflow_dispatch:
  push:
    branches: [ main, master ]
  schedule:
    - cron: '0 2 * * 0'  # æ¯å‘¨æ—¥å‡Œæ™¨2ç‚¹æž„å»º

jobs:
  docker-build:
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      with:
        submodules: false  # Skip submodules to avoid private spam-filter dependency

    - name: Set up Docker Buildx
      uses: docker/setup-buildx-action@v3

    - name: Login to GitHub Container Registry
      uses: docker/login-action@v3
      with:
        registry: ghcr.io
        username: ${{ github.actor }}
        password: ${{ secrets.GITHUB_TOKEN }}

    - name: Create Dockerfile
      run: |
        cat > Dockerfile << 'EOF'
        FROM openjdk:21-jdk-slim
        
        # å®‰è£…å¿…è¦çš„ä¾èµ–
        RUN apt-get update && apt-get install -y \
            protobuf-compiler \
            maven \
            && rm -rf /var/lib/apt/lists/*
        
        # è®¾ç½®å·¥ä½œç›®å½•
        WORKDIR /app
        
        # å¤åˆ¶æºä»£ç 
        COPY . .
        
        # æž„å»ºåº”ç”¨
        RUN mvn clean package -DskipTests
        
        # åˆ›å»ºè¿è¡Œæ—¶é•œåƒ
        FROM openjdk:21-jre-slim
        
        # åˆ›å»ºç”¨æˆ·
        RUN groupadd -r signal && useradd -r -g signal signal
        
        # è®¾ç½®å·¥ä½œç›®å½•
        WORKDIR /app
        
        # å¤åˆ¶æž„å»ºäº§ç‰©
        COPY --from=0 /app/service/target/service-*.jar signal-server.jar
        COPY --from=0 /app/websocket-resources/target/websocket-resources-*.jar websocket-resources.jar
        COPY --from=0 /app/service/config/sample.yml config.yml
        
        # åˆ›å»ºå¯åŠ¨è„šæœ¬
        RUN echo '#!/bin/bash\njava -jar signal-server.jar server config.yml' > start.sh && \
            chmod +x start.sh && \
            chown -R signal:signal /app
        
        # åˆ‡æ¢ç”¨æˆ·
        USER signal
        
        # æš´éœ²ç«¯å£
        EXPOSE 8080 8081
        
        # å¥åº·æ£€æŸ¥
        HEALTHCHECK --interval=30s --timeout=10s --start-period=60s --retries=3 \
          CMD curl -f http://localhost:8081/health || exit 1
        
        # å¯åŠ¨å‘½ä»¤
        CMD ["./start.sh"]
        EOF

    - name: Build and push Docker image
      uses: docker/build-push-action@v5
      with:
        context: .
        push: true
        tags: |
          ghcr.io/${{ github.repository_owner }}/signal-server:latest
          ghcr.io/${{ github.repository_owner }}/signal-server:build-${{ github.run_number }}
          ghcr.io/${{ github.repository_owner }}/signal-server:carljoy-static-verification
        labels: |
          org.opencontainers.image.title=Signal Server (CarlJoy Modified)
          org.opencontainers.image.description=Signal Server with static verification codes
          org.opencontainers.image.source=${{ github.server_url }}/${{ github.repository }}
          org.opencontainers.image.revision=${{ github.sha }}
          org.opencontainers.image.created=${{ steps.prep.outputs.created }}

    - name: Create docker-compose file
      run: |
        mkdir -p docker-artifacts
        cat > docker-artifacts/docker-compose.yml << 'EOF'
        version: '3.8'
        
        services:
          signal-server:
            image: ghcr.io/${{ github.repository_owner }}/signal-server:latest
            container_name: signal-server
            ports:
              - "8080:8080"
              - "8081:8081"
            volumes:
              - ./config.yml:/app/config.yml:ro
              - signal-data:/app/data
            environment:
              - JAVA_OPTS=-Xmx1g -Xms512m
            restart: unless-stopped
            healthcheck:
              test: ["CMD", "curl", "-f", "http://localhost:8081/health"]
              interval: 30s
              timeout: 10s
              retries: 3
              start_period: 60s
        
        volumes:
          signal-data:
        EOF
        
        # åˆ›å»ºç¤ºä¾‹é…ç½®
        cp service/config/sample.yml docker-artifacts/config.yml
        
        # åˆ›å»ºéƒ¨ç½²è¯´æ˜Ž
        cat > docker-artifacts/README.md << 'EOF'
        # Signal Server Docker éƒ¨ç½²
        
        ## CarlJoy é™æ€éªŒè¯ç ç‰ˆæœ¬
        
        ### å¿«é€Ÿå¯åŠ¨ï¼š
        
        1. **ä¿®æ”¹é…ç½®æ–‡ä»¶**
           ```bash
           # ç¼–è¾‘ config.ymlï¼Œé…ç½®æ•°æ®åº“è¿žæŽ¥ç­‰
           vim config.yml
           ```
        
        2. **å¯åŠ¨æœåŠ¡**
           ```bash
           docker-compose up -d
           ```
        
        3. **æŸ¥çœ‹æ—¥å¿—**
           ```bash
           docker-compose logs -f signal-server
           ```
        
        4. **åœæ­¢æœåŠ¡**
           ```bash
           docker-compose down
           ```
        
        ### ç‰¹æ€§è¯´æ˜Žï¼š
        - ä½¿ç”¨é™æ€éªŒè¯ç æ›¿ä»£çŸ­ä¿¡éªŒè¯
        - æ‰‹æœºå·ä½œä¸ºç”¨æˆ·åï¼ŒéªŒè¯ç ä½œä¸ºå¯†ç 
        - è‡ªåŠ¨åˆ›å»ºæ–°ç”¨æˆ·è´¦æˆ·
        
        ### ç«¯å£è¯´æ˜Žï¼š
        - 8080: ä¸»æœåŠ¡ç«¯å£
        - 8081: ç®¡ç†ç«¯å£ï¼ˆå¥åº·æ£€æŸ¥ï¼‰
        
        ### æ•°æ®æŒä¹…åŒ–ï¼š
        åº”ç”¨æ•°æ®å­˜å‚¨åœ¨ `signal-data` å·ä¸­
        EOF

    - name: Upload Docker artifacts
      uses: actions/upload-artifact@v4
      with:
        name: docker-deployment-${{ github.run_number }}
        path: docker-artifacts/
        retention-days: 30

    - name: Create deployment summary
      run: |
        echo "ðŸ³ **Docker é•œåƒæž„å»ºå®Œæˆï¼**" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "ðŸ“¦ **é•œåƒåœ°å€ï¼š**" >> $GITHUB_STEP_SUMMARY
        echo "- \`ghcr.io/${{ github.repository_owner }}/signal-server:latest\`" >> $GITHUB_STEP_SUMMARY
        echo "- \`ghcr.io/${{ github.repository_owner }}/signal-server:build-${{ github.run_number }}\`" >> $GITHUB_STEP_SUMMARY
        echo "- \`ghcr.io/${{ github.repository_owner }}/signal-server:carljoy-static-verification\`" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "ðŸš€ **å¿«é€Ÿä½¿ç”¨ï¼š**" >> $GITHUB_STEP_SUMMARY
        echo "\`\`\`bash" >> $GITHUB_STEP_SUMMARY
        echo "# ä¸‹è½½éƒ¨ç½²æ–‡ä»¶" >> $GITHUB_STEP_SUMMARY
        echo "# ä»Ž Actions é¡µé¢ä¸‹è½½ docker-deployment-${{ github.run_number }}" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "# å¯åŠ¨æœåŠ¡" >> $GITHUB_STEP_SUMMARY
        echo "docker-compose up -d" >> $GITHUB_STEP_SUMMARY
        echo "\`\`\`" >> $GITHUB_STEP_SUMMARY 